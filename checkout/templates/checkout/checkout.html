{% extends "base.html" %}
{% load static %}
{% load crispy_forms_tags %}

{% block content %}
<div class="container my-5">
  <h1 class="mb-4">Checkout</h1>

  <div class="row">
    <!-- Order summary -->
    <div class="col-md-6 mb-4">
      <div class="card card-body">
        <h5 class="mb-3">Your Order</h5>
        {% with items|default:bag_items as items %}
        {% if items %}
          <ul class="list-unstyled">
            {% for i in items %}
              <li class="d-flex justify-content-between">
                <span>
                  {{ i.product.name }}
                  {% if i.option %}<span class="text-muted">({{ i.option.label }})</span>{% endif %}
                  &times; {{ i.quantity }}
                </span>
                <span>€{{ i.line_total|floatformat:2 }}</span>
              </li>
              {% if i.unit_price %}
              <li class="d-flex justify-content-between small text-muted">
                <span>Unit price</span>
                <span>€{{ i.unit_price|floatformat:2 }}</span>
              </li>
              {% endif %}
            {% endfor %}
          </ul>
          <hr>
          <p class="mb-1">Subtotal:
            <strong>€{{ bag_total|default:total|floatformat:2 }}</strong>
          </p>
          {# NEW: Discount line if a code is applied #}
            {% if discount_amount and discount_amount > 0 %}
            <p class="mb-1 text-success">Discount ({{ discount_code }}):
              <strong>- €{{ discount_amount|floatformat:2 }}</strong>
            </p>
            {% endif %}

          <p class="mb-1">Delivery:
            <strong>
              {% if delivery == 0 %}Free{% else %}€{{ delivery|floatformat:2 }}{% endif %}
            </strong>
          </p>
          <p class="lead mb-0">Grand total:
            <strong>€{{ grand_total|floatformat:2 }}</strong>
          </p>
        {% else %}
          <p>Your bag is empty.</p>
        {% endif %}
        {% endwith %}
      </div>
    </div>

    <!-- Payment & details -->
    <div class="col-md-6 mb-4">
      <div class="card card-body">
        <h5 class="mb-3">Billing & Payment</h5>

        <form id="payment-form" method="post" novalidate>
          {% csrf_token %}
          {{ order_form|crispy }}

          <!-- Save my details -->
          <div class="form-check my-2">
            <input class="form-check-input" type="checkbox" name="save_info" id="id_save_info"
                   {% if request.user.is_authenticated and request.user.userprofile %}checked{% endif %}>
            <label class="form-check-label" for="id_save_info">
              Save my details for next time
            </label>
          </div>

          {% if stripe_public_key and client_secret and client_secret != 'test_secret_disabled' %}
            <label for="card-element" class="mt-2">Card details</label>
            <div id="card-element" class="form-control"></div>
            <div id="card-errors" class="text-danger small mt-2" role="alert"></div>

            <input type="hidden" name="client_secret" id="id_client_secret" value="{{ client_secret }}">

            <button type="submit" id="pay-btn" class="btn btn-primary mt-3">
              Pay €{{ grand_total|floatformat:2 }}
            </button>
          {% else %}
            <p class="text-muted small">
              Stripe not configured — placing order without payment (dev only).
            </p>
            <input type="hidden" name="client_secret" value="test_secret_disabled">
            <button type="submit" class="btn btn-primary mt-2">Place Order</button>
          {% endif %}
        </form>
      </div>
    </div>
  </div>
</div>

{% if stripe_public_key and client_secret and client_secret != 'test_secret_disabled' %}
  <script>
    // Stripe Elements setup
    const stripe = Stripe("{{ stripe_public_key }}");
    const elements = stripe.elements();
    const card = elements.create('card');
    card.mount('#card-element');

    card.on('change', function(event) {
      const displayError = document.getElementById('card-errors');
      displayError.textContent = event.error ? event.error.message : '';
    });

    const form = document.getElementById('payment-form');
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const payBtn = document.getElementById('pay-btn');
      if (payBtn) payBtn.disabled = true;

      const clientSecret = document.getElementById('id_client_secret').value;

      // Keep paymentIntent for status-aware handling
      const { error, paymentIntent } = await stripe.confirmCardPayment(clientSecret, {
        payment_method: { card }
      });

      if (error) {
        const displayError = document.getElementById('card-errors');
        displayError.textContent = error.message || 'Payment failed';
        if (payBtn) payBtn.disabled = false;
        return;
      }

      // Optional explicit status check (safe defaults if you want to be strict)
      if (paymentIntent && (paymentIntent.status === 'succeeded' || paymentIntent.status === 'requires_capture')) {
        form.submit();
      } else {
        const displayError = document.getElementById('card-errors');
        displayError.textContent = 'Payment not completed. Please try again.';
        if (payBtn) payBtn.disabled = false;
      }
    });
  </script>
{% endif %}
{% endblock %}
