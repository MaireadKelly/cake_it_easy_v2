{% extends 'base.html' %}
{% load static %}
{% block content %}
  <div class="container mt-5">
    <h1 class="mb-3">Checkout</h1>

    <ul class="list-unstyled">
      {% for i in items %}
        <li>{{ i.product.name }} × {{ i.quantity }} — €{{ i.line_total }}</li>
      {% endfor %}
    </ul>
    <p class="lead"><strong>Total: €{{ total }}</strong></p>
    
    <form id="checkout-form" method="POST" class="card card-body mt-3">
      {% csrf_token %}

      <!-- your existing customer/address form fields stay here -->

      {% if user.is_authenticated %}
        <div class="form-check mt-2">
          <input class="form-check-input" type="checkbox" name="save_info" id="id_save_info" checked>
          <label class="form-check-label" for="id_save_info">
            Save these details to my profile
          </label>
        </div>
      {% endif %}

      <!-- Keep posting client_secret (used by view to link Order to PI) -->
      <input type="hidden" name="client_secret" id="client_secret" value="{{ client_secret }}">

      {% if stripe_public_key and client_secret and client_secret != 'test_secret_disabled' %}
        <hr>
        <h5>Card details</h5>
        <div id="card-element" class="form-control" style="padding:.6rem .75rem;"></div>
        <div id="card-errors" class="text-danger mt-2" role="alert" aria-live="polite"></div>
        <button type="submit" id="pay-btn" class="btn btn-primary mt-3">Pay €{{ total }}</button>
      {% else %}
        <button type="submit" class="btn btn-primary mt-3">Place Order</button>
        <p class="text-muted small mt-2">Payment is disabled in this environment. Your order will still be recorded for assessment.</p>
      {% endif %}
    </form>
  </div>

  {% if stripe_public_key and client_secret and client_secret != 'test_secret_disabled' %}
    <!-- FIXED: load Stripe v3 -->
    <script src="https://js.stripe.com/v3/"></script>
    <script>
      (function () {
        const stripe = Stripe("{{ stripe_public_key }}");
        const clientSecret = "{{ client_secret }}";
        const elements = stripe.elements();
        const card = elements.create('card');
        card.mount('#card-element');

        const byId = (id) => document.getElementById(id)?.value || '';

        // Helper: remove empty fields so Stripe doesn't get "" for keys like 'country'
        const compact = (obj) =>
          Object.fromEntries(Object.entries(obj).filter(([_, v]) => v && String(v).trim() !== ''));

        const form = document.getElementById('checkout-form');
        const payBtn = document.getElementById('pay-btn');
        const errorBox = document.getElementById('card-errors');

        form.addEventListener('submit', async (e) => {
          e.preventDefault();
          if (payBtn) payBtn.disabled = true;
          errorBox.textContent = '';

          const address = compact({
            line1: byId('id_street_address1'),
            line2: byId('id_street_address2'),
            postal_code: byId('id_postcode'),
            city: byId('id_town_or_city'),
            country: byId('id_country').toUpperCase(), // only included if non-empty
          });

          const billingDetails = compact({
            name: byId('id_full_name'),
            email: byId('id_email'),
            address, // may be {}
          });

          const { error, paymentIntent } = await stripe.confirmCardPayment(clientSecret, {
            payment_method: { card, billing_details: billingDetails }
          });

          if (error) {
            errorBox.textContent = error.message || 'Payment failed. Please try again.';
            if (payBtn) payBtn.disabled = false;
            return;
          }
          if (paymentIntent && paymentIntent.status === 'succeeded') form.submit();
          else {
            errorBox.textContent = 'Payment not completed. Please try again.';
            if (payBtn) payBtn.disabled = false;
          }
        });
      })();
    </script>

  {% endif %}
{% endblock %}
