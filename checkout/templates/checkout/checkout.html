{% extends 'base.html' %}
{% load static %}
{% block content %}
<div class="container mt-5">
  <h1 class="mb-3">Checkout</h1>

  <ul class="list-unstyled">
    {% for i in items %}
      <li>{{ i.product.name }} × {{ i.quantity }} — €{{ i.line_total }}</li>
    {% endfor %}
  </ul>
  <p class="lead"><strong>Total: €{{ total }}</strong></p>

  <form id="checkout-form" method="POST" class="card card-body mt-3">
    {% csrf_token %}
    {{ form.as_p }}
    <!-- Always include client_secret so server can record PID -->
    <input type="hidden" name="client_secret" id="client_secret" value="{{ client_secret }}">

    {% if stripe_public_key and client_secret and client_secret != 'test_secret_disabled' %}
      <hr>
      <h5>Card details</h5>
      <div id="card-element" class="form-control" style="padding: .6rem .75rem;"></div>
      <div id="card-errors" class="text-danger mt-2" role="alert"></div>

      <button type="submit" id="pay-btn" class="btn btn-primary mt-3">
        Pay €{{ total }}
      </button>
    {% else %}
      <!-- Demo mode (no Stripe): just place the order -->
      <button type="submit" class="btn btn-primary mt-3">Place Order</button>
      <p class="text-muted small mt-2">
        Payment is disabled in this environment. Your order will still be recorded for assessment.
      </p>
    {% endif %}
  </form>
</div>

{% if stripe_public_key and client_secret and client_secret != 'test_secret_disabled' %}
  <script src="https://js.stripe.com/v3/"></script>
  <script>
    (function () {
      const stripe = Stripe("{{ stripe_public_key }}");
      const clientSecret = "{{ client_secret }}";
      const elements = stripe.elements();
      const card = elements.create('card');
      card.mount('#card-element');

      const form = document.getElementById('checkout-form');
      const payBtn = document.getElementById('pay-btn');
      const errorBox = document.getElementById('card-errors');

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (payBtn) payBtn.disabled = true;
        errorBox.textContent = '';

        const billingDetails = {
          name: document.getElementById('id_full_name')?.value || '',
          email: document.getElementById('id_email')?.value || '',
          address: {
            line1: document.getElementById('id_street_address1')?.value || '',
            line2: document.getElementById('id_street_address2')?.value || '',
            postal_code: document.getElementById('id_postcode')?.value || '',
            city: document.getElementById('id_town_or_city')?.value || '',
            country: document.getElementById('id_country')?.value || '',
          }
        };

        const { error, paymentIntent } = await stripe.confirmCardPayment(clientSecret, {
          payment_method: { card, billing_details: billingDetails }
        });

        if (error) {
          errorBox.textContent = error.message || 'Payment failed. Please try again.';
          if (payBtn) payBtn.disabled = false;
          return;
        }

        if (paymentIntent && paymentIntent.status === 'succeeded') {
          // Let Django create Order + LineItems using the same POST payload
          form.submit();
        } else {
          errorBox.textContent = 'Payment not completed. Please try again.';
          if (payBtn) payBtn.disabled = false;
        }
      });
    })();
  </script>
{% endif %}
{% endblock %}
